const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const http = require('http');
const socketIo = require('socket.io');
const jsPDF = require('jspdf');
const fetch = require('node-fetch');
const cron = require('node-cron');

const app = express();
const server = http.createServer(app);
const io = socketIo(server);
const db = new sqlite3.Database('logistics.db');

const ORS_API_KEY = 'YOUR_ORS_API_KEY'; // Free tier sufficient

// Setup DB
db.serialize(() => {
  db.run(`CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, name TEXT, email TEXT, available BOOLEAN DEFAULT 1, preferences TEXT, location TEXT)`);
  db.run(`CREATE TABLE IF NOT EXISTS loads (id INTEGER PRIMARY KEY, origin TEXT, destination TEXT, cargo TEXT, status TEXT DEFAULT 'available', assigned_to INTEGER, bid_price REAL)`);
  db.run(`CREATE TABLE IF NOT EXISTS history (id INTEGER PRIMARY KEY, load_id INTEGER, event TEXT, timestamp DATETIME DEFAULT CURRENT_TIMESTAMP)`);
});

// Serve static files
app.use(express.static(__dirname));
app.use(express.json());

// Register user
app.post('/register', (req, res) => {
  const { name, email, preferences } = req.body;
  db.run(`INSERT INTO users (name, email, preferences) VALUES (?, ?, ?)`, [name, email, preferences || ''], function(err) {
    if (err) return res.status(500).send('Error');
    res.send({ id: this.lastID });
  });
});

// Dashboard
app.get('/dashboard/:userId', (req, res) => {
  const userId = req.params.userId;
  db.all(`SELECT * FROM loads WHERE assigned_to = ?`, [userId], (err, loads) => {
    if (err) return res.status(500).send('Error');
    res.send(loads || []);
  });
});

// Paperwork
app.get('/paperwork/:loadId', (req, res) => {
  const loadId = req.params.loadId;
  db.get(`SELECT * FROM loads WHERE id = ?`, [loadId], (err, load) => {
    if (err || !load) return res.status(500).send('Error');
    const doc = new jsPDF();
    doc.text(`Bill of Lading - All Logic Logistics`, 10, 10);
    doc.text(`Load ID: ${loadId}`, 10, 20);
    doc.text(`Origin: ${load.origin}`, 10, 30);
    doc.text(`Destination: ${load.destination}`, 10, 40);
    doc.text(`Cargo: ${load.cargo}`, 10, 50);
    doc.text(`Bid: $${load.bid_price || 'AI Optimized'}`, 10, 60);
    res.setHeader('Content-Type', 'application/pdf');
    res.send(doc.output());
  });
});

// Route Optimization
async function optimizeRoute(origin, destination) {
  try {
    const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=\( {ORS_API_KEY}&start= \){encodeURIComponent(origin)}&end=${encodeURIComponent(destination)}`;
    const response = await fetch(url);
    const data = await response.json();
    return data.routes?.[0]?.summary || { distance: 1000, duration: 3600 };
  } catch (e) {
    return { distance: 1000, duration: 3600 }; // Fallback
  }
}

// Advanced Matching Score
function matchScore(driver, load) {
  let score = 100;
  // Simple distance placeholder (expand with real coords)
  if (driver.preferences && load.cargo && !driver.preferences.toLowerCase().includes(load.cargo.toLowerCase())) score -= 30;
  return score;
}

// HOS Check Placeholder
function checkHOS(driverId) {
  return true; // Expand with real logic later
}

// Load Real/Free Data (Zero Cost)
async function fetchRealLoads() {
  // Expanded realistic samples (zero cost, always available)
  const sampleLoads = [
    { origin: 'Dallas, TX', destination: 'Atlanta, GA', cargo: 'Dry Van - Consumer Goods' },
    { origin: 'Los Angeles, CA', destination: 'Chicago, IL', cargo: 'Reefer - Produce' },
    { origin: 'New York, NY', destination: 'Miami, FL', cargo: 'Flatbed - Machinery' },
    { origin: 'Houston, TX', destination: 'Denver, CO', cargo: 'Dry Van - Electronics' },
    { origin: 'Seattle, WA', destination: 'Phoenix, AZ', cargo: 'Reefer - Frozen Foods' },
    { origin: 'Chicago, IL', destination: 'Detroit, MI', cargo: 'Flatbed - Steel' },
    { origin: 'Atlanta, GA', destination: 'Boston, MA', cargo: 'Dry Van - Apparel' },
    // Add more as needed
  ];

  sampleLoads.forEach((load, index) => {
    db.run(`INSERT OR IGNORE INTO loads (id, origin, destination, cargo, status) VALUES (?, ?, ?, ?, 'available')`,
      [index + 1, load.origin, load.destination, load.cargo]);
  });

  // Placeholder for free load boards (no API fees):
  // - TruckSmarter: 100% free, 100K+ loads, great for owner-ops
  // - Trucker Path TruckLoads: Free unlimited 150K+ loads
  // - Direct Freight: Free 300K+ loads daily
  // - Trulos: Free, no login, ad-supported
  // To auto-fetch: Use server-side scraping of public search results (if terms allow) or let users post loads manually.
  // Example future fetch (public RSS if available): await fetch('https://some-free-board.com/public-feeds');
}

// AI Dispatcher Cron
cron.schedule('*/5 * * * *', async () => {
  await fetchRealLoads(); // Load samples/free data
  db.all(`SELECT * FROM loads WHERE status = 'available'`, async (err, loads) => {
    if (err || !loads.length) return;
    db.all(`SELECT * FROM users WHERE available = 1`, async (err, drivers) => {
      if (err || !drivers.length) return;
      for (let load of loads) {
        const bestDriver = drivers.reduce((best, d) => matchScore(d, load) > matchScore(best, load) ? d : best, drivers[0]);
        if (!checkHOS(bestDriver.id)) continue;
        const route = await optimizeRoute(load.origin, load.destination);
        const bidPrice = Math.floor(Math.random() * 1500) + 800; // AI bid
        db.run(`UPDATE loads SET assigned_to = ?, status = 'assigned', bid_price = ? WHERE id = ?`, [bestDriver.id, bidPrice, load.id]);
        db.run(`UPDATE users SET available = 0, location = ? WHERE id = ?`, [load.destination, bestDriver.id]);
        io.emit('update', { loadId: load.id, driverId: bestDriver.id, route, bidPrice });
        db.run(`INSERT INTO history (load_id, event) VALUES (?, 'Assigned by AI')`, [load.id]);

        // Simulate progress
        setTimeout(() => {
          db.run(`UPDATE loads SET status = 'in_transit' WHERE id = ?`, [load.id]);
          io.emit('update', { loadId: load.id, status: 'in_transit' });
        }, 10000);
        setTimeout(() => {
          db.run(`UPDATE loads SET status = 'completed' WHERE id = ?`, [load.id]);
          db.run(`UPDATE users SET available = 1 WHERE id = ?`, [bestDriver.id]);
          io.emit('update', { loadId: load.id, status: 'completed' });
        }, 20000);
      }
    });
  });
});

// Location updates
io.on('connection', (socket) => {
  socket.on('updateLocation', (data) => {
    db.run(`UPDATE users SET location = ? WHERE id = ?`, [data.location, data.userId]);
  });
});

server.listen(3000, () => console.log('All Logic Logistics running at http://localhost:3000 - Zero ongoing costs!'));